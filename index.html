<!DOCTYPE html>
<html lang="tg">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>KORYOB.TJ ‚Äî –ö–æ—Ä—ë–±”£</title>
<link rel="icon" type="image/png" href="koryob.logo.png">
<style>
  :root{
    --blue:#ff7b00;
    --bg:#fff8f3;
    --online:#28a745; 
    --gray-light: #f5f5f5;
    --read-receipt: #00b8d4; /* –†–∞–Ω–≥–∏ –Ω–∞–≤–∏ –±–∞—Ä–æ–∏ –î–∏–¥–∞ —à—É–¥ */
  }
  body{font-family:Inter, sans-serif;margin:0;background:var(--bg);color:#222}
  header{background:#fff;display:flex;justify-content:space-between;align-items:center;padding:12px 18px;box-shadow:0 2px 6px rgba(0,0,0,0.06);position:sticky;top:0;z-index:20}
  .logo{color:var(--blue);font-weight:700}
  nav{display:flex;gap:10px;align-items:center}
  .badge{background:#f1f5f9;padding:6px 10px;border-radius:10px;color:#333;font-size:14px}
  .container{max-width:900px;margin:18px auto;padding:0 16px}
  .hero{text-align:center;padding:28px 10px;background:linear-gradient(180deg,#fff3e6,#fff);border-radius:10px}
  .hero h1{margin:0;color:#222}
  .hero p{color:#555;margin:8px 0 0}
  
  /* –¢–∞—Ä“≥–±–∞–Ω–¥–∏–∏ —Ç–∞–≥ –±–∞ —Ç–∞–≥ –±–∞—Ä–æ–∏ “∑—É—Å—Ç—É“∑”Ø */
  .search{
    margin-top:12px;
    display:flex;
    flex-direction: column; 
    align-items: center; 
    gap: 10px;
  }
  .search input{
    width:100%; max-width: 480px; 
    padding:10px;border-radius:25px;border:1px solid #ddd;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
  }
  .search select {
    width: 100%;
    max-width: 480px; 
    padding: 10px;
    border: 1px solid #ddd; 
    border-radius: 25px; 
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    background: #fff;
  }
  
  .jobs{margin-top:18px}
  .job-card{background:#fff;border-radius:12px;padding:14px;margin-bottom:12px;box-shadow:0 2px 8px rgba(0,0,0,0.04)}
  .job-card h3{margin:0;color:var(--blue)}
  .small{color:#666;font-size:13px;margin:6px 0}
  .muted{color:#888;font-size:12px}
  .btn{background:var(--blue);color:#fff;border:none;padding:8px 12px;border-radius:8px;cursor:pointer}
  .btn.ghost{background:transparent;color:var(--blue);border:1px solid rgba(0,0,0,0.06)}
  .btn.danger{background:#dc3545}
  .btn.warn{background:#ffc107;color:#000}
  .row{display:flex;gap:8px;margin-top:8px}
  footer{margin:26px 0;text-align:center;color:#666;font-size:13px}
  
  /* Modal Styles */
  .modal{
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.5);
    justify-content: center;
    align-items: center;
    padding: 20px;
    z-index: 60;
    overflow-y: auto;
  }
  .modal .card{background:#fff;padding:18px;border-radius:12px;width:100%;max-width:420px;box-shadow:0 6px 24px rgba(0,0,0,0.12)}
  .modal .card h3{margin:0 0 8px;color:var(--blue)}
  .input, textarea {
    width: 100%;
    padding: 10px;
    margin: 8px 0;
    border-radius: 8px;
    border: 1px solid #ccc;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    transition: border-color 0.3s ease;
    box-sizing: border-box;
  }
  
  /* Chat Full-Screen Styles */
  #chatModal.modal { background: var(--bg); padding: 0; }
  #chatModal .card {
    width: 100%; height: 100%; max-width: 100%; max-height: 100vh;
    margin: 0; border-radius: 0; box-shadow: none; display: flex; flex-direction: column;
  }
  .chat-header {
    display: flex; justify-content: space-between; align-items: center;
    padding: 12px 18px; border-bottom: 1px solid #ddd; background: #fff; flex-shrink: 0; 
  }
  .chat-list { flex: 1; overflow-y: auto; padding: 0 10px; background: #fff; }
  .chat-window { flex: 1; overflow-y: auto; padding: 10px; display: flex; flex-direction: column; gap: 8px; }
  .chat-input-area {
    padding: 10px; border-top: 1px solid #eee; display: flex; gap: 8px;
    align-items: center; background: #fff; flex-shrink: 0; 
  }
  
  /* –ù–ê–í–°–û–ó”¢ –®–£–î: –ò–¥–æ—Ä–∞–∫—É–Ω–∏–∏ —Ç–∞–Ω–∞—Ñ—Ñ—É—Å–∏ –º–∞—Ç–Ω */
  .chat-message{
    margin:4px 0;padding:8px;border-radius:8px;max-width:80%; 
    display: flex; justify-content: space-between; align-items: flex-end;
    line-height: 1.4;
    word-break: break-word; /* –±–∞—Ä–æ–∏ –∫–∞–ª–∏–º–∞“≥–æ–∏ —Ö–µ–ª–µ –¥–∞—Ä–æ–∑ */
    white-space: normal;
  }
  
  .chat-message > span:first-child { 
      word-break: break-word; 
      white-space: pre-wrap;
      flex-grow: 1; 
  }

  .chat-message > span:last-child {
      flex-shrink: 0;
      margin-left: 10px; 
      white-space: nowrap;
  }

  .chat-message.sent{background:#e0f7fa;color:#222;align-self: flex-end}
  .chat-message.received{background:#f1f1f1;color:#222;align-self: flex-start}

  .fab{position:fixed;bottom:20px;right:20px;background:var(--blue);color:white;border-radius:50%;width:50px;height:50px;font-size:30px;border:none;cursor:pointer;display:none;z-index:50}
  .menu-list{list-style:none;padding:0}
  .menu-list li{margin:10px 0}
  .menu-list button{width:100%;padding:10px;text-align:left}

  /* –°–¢–ò–õ–ò –û–ì–û“≤–ò–ò –ù–ê–í */
  .notification{ 
    position: fixed; 
    top: 10px; 
    right: 10px; 
    background: #dc3545; 
    color: white; 
    padding: 8px 15px; 
    border-radius: 8px; 
    display: none; 
    font-weight: bold;
    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    z-index: 100;
  }
  
  /* –°—Ç–∏–ª–∏–∏ –º–æ–¥–∞–ª“≥–æ–∏ Full-Screen (–ü—Ä–æ—Ñ–∏–ª, –≠—ä–ª–æ–Ω“≥–æ–∏ –º–∞–Ω) */
  #profileModal.modal, #myJobsContainer.modal { background: var(--gray-light); padding: 0; }
  #profileModal .card, #myJobsContainer .card { max-width: 100%; height: 100vh; border-radius: 0; padding: 0; display: flex; flex-direction: column; }
  .profile-header, .job-header {
      padding: 15px 18px; background: var(--blue); color: white; display: flex;
      align-items: center; justify-content: space-between; flex-shrink: 0;
  }
  .profile-content, .job-list-content { padding: 18px; overflow-y: auto; flex: 1; background: var(--gray-light);}
  
  /* –°—Ç–∏–ª–∏–∏ –Ω–∞–≤–∏ –ü—Ä–æ—Ñ–∏–ª */
  .profile-section{margin-bottom: 25px; background: white; border-radius: 10px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.05);}
  .profile-section h4 { 
    color: #444; margin: 0; padding: 12px 15px; background: #fff; 
    border-bottom: 1px solid #eee; font-size: 16px;
  }
  .profile-item {
    display: flex; justify-content: space-between; align-items: center; 
    padding: 12px 15px; border-bottom: 1px solid #eee; cursor: pointer;
    transition: background 0.2s;
  }
  .profile-item:last-child { border-bottom: none; }
  .profile-item:hover { background: var(--gray-light); }
  .profile-label { color: #555; font-size: 14px; }
  .profile-value { font-weight: 500; color: #222; font-size: 14px;}
  .profile-action-btn { background: none; color: var(--blue); border: none; padding: 0 5px; cursor: pointer; font-size: 14px;}

  /* –°—Ç–∏–ª–∏–∏ —ç–ª–µ–º–µ–Ω—Ç“≥–æ–∏ —Ä”Ø–π—Ö–∞—Ç–∏ –ß–∞—Ç */
  .chat-list-item{
      display: flex; justify-content: space-between; align-items: center; padding: 10px;
      border-bottom: 1px solid #eee; cursor: pointer; transition: background 0.2s;
  }
  .chat-list-item:hover{ background: #f5f5f5; }
  .chat-info{ display: flex; align-items: center; }
  .online-status{ 
      width: 10px; height: 10px; border-radius: 50%; margin-right: 8px; 
      background: var(--muted-color, #ccc); 
      flex-shrink: 0;
  }
  .online-status.online{ background: var(--online); }
  .last-message{ font-size: 12px; color: #888; margin-top: 4px; }
</style>
</head>
<body>

  <header>
    <div class="logo">KORYOB.TJ</div>
    <nav id="navArea"></nav>
    <div id="notification" class="notification">–ü–∞—ë–º–∏ –Ω–∞–≤!</div>
  </header>

  <main class="container">
    <section class="hero">
      <h1>–ö–æ—Ä–∏ –æ—Ä–∑”Ø–∏ —Ö—É–¥—Ä–æ —ë–±–µ–¥</h1>
      <p>KORYOB TJ-–ü–ª–∞—Ç—Ñ–æ—Ä–º–∞–∏ ‚Ññ1 –±–∞—Ä–æ–∏ –¥–∞—Ä—ë—Ñ—Ç–∏ “∑–æ–π“≥–æ–∏ –∫–æ—Ä–∏ –¥–∞—Ä –¢–æ“∑–∏–∫–∏—Å—Ç–æ–Ω. “≤–∞–∑–æ—Ä–æ–Ω “∑–æ–π“≥–æ–∏ –∫–æ—Ä–∏—Ä–æ –∞–∑ –º–æ –ø–∞–π–¥–æ –∫—É–Ω–µ–¥ </p>
      <div class="search">
        <input id="searchInput" placeholder="“∂—É—Å—Ç—É“∑”Ø: –≤–∞–∑–∏—Ñ–∞, —à–∏—Ä–∫–∞—Ç —ë —à–∞“≥—Ä..." />
        <select id="cityFilter">
          <option value="">“≤–∞–º–∞ —à–∞“≥—Ä“≥–æ</option>
          <option value="–î—É—à–∞–Ω–±–µ">–î—É—à–∞–Ω–±–µ</option>
          <option value="–†–æ“ì—É–Ω">–†–æ“ì—É–Ω</option>
          <option value="–ë–æ—Ö—Ç–∞—Ä">–ë–æ—Ö—Ç–∞—Ä</option>
          <option value="–ò—Å—Ç–∞—Ä–∞–≤—à–∞–Ω">–ò—Å—Ç–∞—Ä–∞–≤—à–∞–Ω</option>
          <option value="–ò—Å—Ñ–∞—Ä–∞">–ò—Å—Ñ–∞—Ä–∞</option>
          <option value="–ö–æ–Ω–∏–±–æ–¥–æ–º">–ö–æ–Ω–∏–±–æ–¥–æ–º</option>
          <option value="–ö”Ø–ª–æ–±">–ö”Ø–ª–æ–±</option>
          <option value="–¢—É—Ä—Å—É–Ω–∑–æ–¥–∞">–¢—É—Ä—Å—É–Ω–∑–æ–¥–∞</option>
          <option value="–í–∞“≥–¥–∞—Ç">–í–∞“≥–¥–∞—Ç</option>
          <option value="–•—É“∑–∞–Ω–¥">–•—É“∑–∞–Ω–¥</option>
        </select>
      </div>
    </section>

    <section class="jobs" id="jobListArea">
      <h2 style="margin-top:18px">–≠—ä–ª–æ–Ω“≥–æ–∏ “∑–æ—Ä”£</h2>
      <div id="jobList"></div>
    </section>
  </main>

  <footer>¬© <span id="year"></span> KORYOB.TJ ‚Äî “≤–∞–º–∞–∏ “≥—É“õ—É“õ“≥–æ “≥–∏—Ñ–∑ —à—É–¥–∞–∞–Ω–¥.</footer>

  <div class="modal" id="policyModal">
      <div class="card">
          <h3>–°–∏—ë—Å–∞—Ç–∏ –º–∞—Ö—Ñ–∏—è—Ç (Privacy Policy)</h3>
          <div style="max-height: 250px; overflow-y: auto; text-align: justify; padding-right: 10px;">
              <p class="small">
                  **1. “∂–∞–º—ä–æ–≤–∞—Ä–∏–∏ –º–∞—ä–ª—É–º–æ—Ç:** –ú–æ —Ç–∞–Ω“≥–æ –Ω–æ–º, –ø–æ—á—Ç–∞–∏ —ç–ª–µ–∫—Ç—Ä–æ–Ω”£ –≤–∞ –Ω–∞“õ—à–∏ (–ö–æ—Ä—ë–±/–ö–æ—Ä—Ñ–∞—Ä–º–æ) —à—É–º–æ—Ä–æ “∑–∞–º—ä –º–µ–æ—Ä–µ–º. –ú–∞—ä–ª—É–º–æ—Ç–∏ —à–∞—Ö—Å–∏–∏ —à—É–º–æ –¥–∞—Ä –¥–æ–∏—Ä–∞–∏ –ª–æ–∏“≥–∞–∏ KORYOB.TJ –±–æ –º–∞“õ—Å–∞–¥–∏ —Ç–∞—ä–º–∏–Ω–∏ —Ñ—É–Ω–∫—Å–∏–æ–Ω–∞–ª–∏–∏ –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞ –∏—Å—Ç–∏—Ñ–æ–¥–∞ –º–µ—à–∞–≤–∞–¥.
              </p>
              <p class="small">
                  **2. –ü–∞—Ä–æ–ª“≥–æ:** –ü–∞—Ä–æ–ª“≥–æ –±–æ –∏—Å—Ç–∏—Ñ–æ–¥–∞ –∞–∑ Firebase Authentication —Ä–∞–º–∑–≥—É–∑–æ—Ä”£ (hashed) –∫–∞—Ä–¥–∞ –º–µ—à–∞–≤–∞–Ω–¥ –≤–∞ –¥–∞—Å—Ç—Ä–∞—Å –Ω–µ—Å—Ç–∞–Ω–¥.
              </p>
              <p class="small">
                  **3. –ú—É–æ—à–∏—Ä–∞—Ç:** –ü–∞—ë–º“≥–æ–∏ —á–∞—Ç –±–∞–π–Ω–∏ –∫–æ—Ä–±–∞—Ä–æ–Ω —Ç–∞–Ω“≥–æ –±–æ –º–∞“õ—Å–∞–¥–∏ –∏—Ä—Ç–∏–±–æ—Ç –Ω–∏–≥–æ“≥ –¥–æ—à—Ç–∞ –º–µ—à–∞–≤–∞–Ω–¥.
              </p>
              <p class="small">
                  **4. –≠—ä–ª–æ–Ω“≥–æ:** –≠—ä–ª–æ–Ω“≥–æ–∏ –∫–æ—Ä”£ (–≤–∞–∑–∏—Ñ–∞, –º–∞–æ—à, —Ç–µ–ª–µ—Ñ–æ–Ω) –æ–º–º–∞–≤”£ –º–µ–±–æ—à–∞–Ω–¥ –≤–∞ –±–∞—Ä–æ–∏ “≥–∞–º–∞ –¥–∞—Å—Ç—Ä–∞—Å–∞–Ω–¥.
              </p>
              <p class="small">
                  **5. “≤—É“õ—É“õ:** –ë–æ –ø–∞—Ö—à–∏ —Ç—É–≥–º–∞–∏ "“ö–∞–±—É–ª –º–µ–∫—É–Ω–∞–º", —à—É–º–æ –±–∞ —à–∞—Ä—Ç“≥–æ–∏ –¥–∞—Ä –±–æ–ª–æ –∑–∏–∫—Ä—à—É–¥–∞ —Ä–æ–∑”£ –º–µ—à–∞–≤–µ–¥.
              </p>
          </div>
          <div class="row" style="margin-top:15px; justify-content: flex-end;">
              <button class="btn ghost danger" onclick="closeModal('policyModal')">–ë–µ–∫–æ—Ä</button>
              <button class="btn" onclick="acceptPolicyAndOpenSignup()">“ö–∞–±—É–ª –º–µ–∫—É–Ω–∞–º</button>
          </div>
      </div>
  </div>

  <div class="modal" id="signupModal">
    <div class="card">
      <h3>“ö–∞–π–¥ —à—É–¥–∞–Ω</h3>
      <input id="signupName" class="input" placeholder="–ù–æ–º –≤–∞ –Ω–∞—Å–∞–± (–º–∏–Ω. 3 –∞–ª–æ–º–∞—Ç)">
      <input id="signupEmail" class="input" placeholder="–ü–æ—á—Ç–∞–∏ —ç–ª–µ–∫—Ç—Ä–æ–Ω”£ (email)">
      <input id="signupPassword" type="password" class="input" placeholder="–ü–∞—Ä–æ–ª (–º–∏–Ω. 6 –∞–ª–æ–º–∞—Ç)">
      <label class="muted">–†–æ–ª (–ø–æ–∑–∏—Ü–∏—è):</label>
      <div style="margin:6px 0" class="row">
        <label style="flex:1"><input type="radio" name="role" value="korjob" checked> –ö–æ—Ä“∑—É–π</label>
        <label style="flex:1"><input type="radio" name="role" value="korfarmo"> –ö–æ—Ä—Ñ–∞—Ä–º–æ</label>
      </div>
      <div class="row" style="margin-top:8px">
        <button class="btn" onclick="signup()">–°–∞–±—Ç –∫–∞—Ä–¥–∞–Ω</button>
        <button class="btn ghost" onclick="closeModal('signupModal')">–ë–µ–∫–æ—Ä</button>
      </div>
      <div id="signupMsg" class="muted" style="margin-top:8px"></div>
    </div>
  </div>

  <div class="modal" id="loginModal">
    <div class="card">
      <h3>–í–æ—Ä–∏–¥—à–∞–≤”£</h3>
      <input id="loginEmail" class="input" placeholder="–ü–æ—á—Ç–∞–∏ —ç–ª–µ–∫—Ç—Ä–æ–Ω”£ (email)">
      <input id="loginPassword" type="password" class="input" placeholder="–ü–∞—Ä–æ–ª (–º–∏–Ω. 6 –∞–ª–æ–º–∞—Ç)">
      <div class="row" style="margin-top:8px">
        <button class="btn" onclick="login()">–í–æ—Ä–∏–¥ —à—É–¥–∞–Ω</button>
        <button class="btn ghost" onclick="closeModal('loginModal')">–ë–µ–∫–æ—Ä</button>
      </div>
      <p class="small" style="text-align:right; margin-top:10px;">
          <a href="#" onclick="openModal('forgotPasswordModal'); closeModal('loginModal')" style="color:var(--blue); text-decoration: none;">–ü–∞—Ä–æ–ª—Ä–æ —Ñ–∞—Ä–æ–º”Ø—à –∫–∞—Ä–¥–∞–º?</a>
      </p>
      <div id="loginMsg" class="muted" style="margin-top:8px"></div>
    </div>
  </div>
  
  <div class="modal" id="forgotPasswordModal">
    <div class="card">
      <h3>–ë–∞—Ä“õ–∞—Ä–æ—Ä–∫—É–Ω–∏–∏ –ø–∞—Ä–æ–ª</h3>
      <p class="small">–ü–æ—á—Ç–∞–∏ —ç–ª–µ–∫—Ç—Ä–æ–Ω–∏–∏ —Ö—É–¥—Ä–æ –≤–æ—Ä–∏–¥ –∫—É–Ω–µ–¥. –ú–æ –±–∞ —à—É–º–æ –ø–∞–π–≤–∞–Ω–¥–∏ —Ç–∞“ì–π–∏—Ä–∏ –ø–∞—Ä–æ–ª –º–µ—Ñ–∏—Ä–∏—Å—Ç–µ–º.</p>
      <input id="forgotEmail" class="input" placeholder="–ü–æ—á—Ç–∞–∏ —ç–ª–µ–∫—Ç—Ä–æ–Ω”£ (email)">
      <div class="row" style="margin-top:8px">
        <button class="btn" onclick="forgotPassword()">–ò—Ä—Å–æ–ª</button>
        <button class="btn ghost" onclick="closeModal('forgotPasswordModal')">–ë–µ–∫–æ—Ä</button>
      </div>
      <div id="forgotMsg" class="muted" style="margin-top:8px"></div>
    </div>
  </div>

  <div class="modal" id="createJobModal">
    <div class="card">
      <h3>–≠—ä–ª–æ–Ω–∏ –∫–æ—Ä —ç“∑–æ–¥ –∫—É–Ω–µ–¥</h3>
      <input id="jobTitle" class="input" placeholder="–ù–æ–º–∏ –≤–∞–∑–∏—Ñ–∞ (–º–∞—Å–∞–ª–∞–Ω: –ú—É“≥–∞–Ω–¥–∏—Å)">
      <input id="jobCompany" class="input" placeholder="–ù–æ–º–∏ —à–∏—Ä–∫–∞—Ç">
      <input id="jobCity" class="input" placeholder="–®–∞“≥—Ä">
      <input id="jobSalary" class="input" placeholder="–ú–∞–æ—à (–º–∞—Å–∞–ª–∞–Ω: 1200 - 1800)">
      <input id="jobHours" class="input" placeholder="–°–æ–∞—Ç“≥–æ–∏ –∫–æ—Ä”£ (–º–∞—Å–∞–ª–∞–Ω: 07:00 - 18:00)">
      <input id="jobAge" class="input" placeholder="–°–∏–Ω–Ω—É —Å–æ–ª (–º–∞—Å–∞–ª–∞–Ω: –∞–∑ 20 —Ç–æ 25)">
      <input id="jobPhone" class="input" placeholder="–ù–æ–º–µ—Ä–∏ —Ç–µ–ª–µ—Ñ–æ–Ω (–º–∞—Å–∞–ª–∞–Ω: +992 93 123 45 67)">
      <select id="jobGender" class="input">
        <option value="–§–∞—Ä“õ –Ω–∞–¥–æ—Ä–∞–¥">“∂–∏–Ω—Å: –§–∞—Ä“õ –Ω–∞–¥–æ—Ä–∞–¥</option>
        <option value="–ú–∞—Ä–¥">–ú–∞—Ä–¥</option>
        <option value="–ó–∞–Ω">–ó–∞–Ω</option>
      </select>
      <textarea id="jobDesc" class="input" placeholder="–¢–∞–≤—Å–∏—Ñ–∏ –≤–∞–∑–∏—Ñ–∞..." rows="4"></textarea>
      <div class="row" style="margin-top:8px">
        <button class="btn" onclick="createJob()">–ù–∞—à—Ä –∫–∞—Ä–¥–∞–Ω</button>
        <button class="btn ghost" onclick="closeModal('createJobModal')">–ë–µ–∫–æ—Ä</button>
      </div>
      <div id="createJobMsg" class="muted" style="margin-top:8px"></div>
    </div>
  </div>

  <div class="modal" id="profileModal">
    <div class="card" style="display: flex; flex-direction: column;">
        <div class="profile-header">
            <button class="btn ghost" onclick="closeModal('profileModal')" style="font-size: 20px; padding: 5px 10px; margin-right: 10px; background: none; color: white; border: none;">‚Üê</button>
            <h3 style="margin: 0; color: white;">–ü—Ä–æ—Ñ–∏–ª–∏ –º–∞–Ω</h3>
            <span></span>
        </div>
        <div class="profile-content">
            <div style="text-align: center; margin-bottom: 25px;">
              <div style="width: 80px; height: 80px; background: #ffe0b2; color: var(--blue); border-radius: 50%; display: inline-flex; justify-content: center; align-items: center; font-size: 36px; font-weight: bold;">
                <span id="profileInitial"></span>
              </div>
              <h2 id="profileDisplayName" style="margin: 8px 0 2px;"></h2>
              <p class="muted" id="profileDisplayRole" style="margin: 0; font-size: 14px;"></p>
            </div>

            <div class="profile-section">
                <h4>–ú–∞—ä–ª—É–º–æ—Ç–∏ —É–º—É–º”£</h4>
                <div id="profileInfoContent">
                  </div>
            </div>
            
            <div class="profile-section">
                <h4>–ê–º–∞–ª“≥–æ</h4>
                <div class="profile-item" onclick="openEditNameModal()">
                    <span class="profile-label">–¢–∞“ì–π–∏—Ä –¥–æ–¥–∞–Ω–∏ –Ω–æ–º</span>
                    <span class="profile-action-btn">‚Üí</span>
                </div>
                <div class="profile-item" onclick="openModal('changePasswordModal')">
                    <span class="profile-label">–ò–≤–∞–∑ –∫–∞—Ä–¥–∞–Ω–∏ –ø–∞—Ä–æ–ª</span>
                    <span class="profile-action-btn">‚Üí</span>
                </div>
                <div class="profile-item" onclick="logout(); closeModal('profileModal')" style="color: #dc3545;">
                    <span class="profile-label">–ë–∞—Ä–æ–º–∞–¥ –∞–∑ –∞–∫–∫–∞—É–Ω—Ç</span>
                    <span class="profile-action-btn" style="color: #dc3545;">‚Üí</span>
                </div>
            </div>
        </div>
    </div>
  </div>
  
  <div class="modal" id="editNameModal">
    <div class="card">
      <h3>–¢–∞“ì–π–∏—Ä –¥–æ–¥–∞–Ω–∏ –Ω–æ–º</h3>
      <input id="editNameInput" class="input" placeholder="–ù–æ–º–∏ –Ω–∞–≤ (–º–∏–Ω. 3 –∞–ª–æ–º–∞—Ç)">
      <div class="row" style="margin-top:8px">
        <button class="btn" onclick="updateProfileName()">–¢–∞“ì–π–∏—Ä –¥–æ–¥–∞–Ω</button>
        <button class="btn ghost" onclick="closeModal('editNameModal')">–ë–µ–∫–æ—Ä</button>
      </div>
      <div id="editNameMsg" class="muted" style="margin-top:8px"></div>
    </div>
  </div>

  <div class="modal" id="changePasswordModal">
    <div class="card">
      <h3>–ò–≤–∞–∑ –∫–∞—Ä–¥–∞–Ω–∏ –ø–∞—Ä–æ–ª</h3>
      <input id="currentPassword" type="password" class="input" placeholder="–ü–∞—Ä–æ–ª–∏ –ø–µ—à–∏–Ω–∞">
      <input id="newPassword" type="password" class="input" placeholder="–ü–∞—Ä–æ–ª–∏ –Ω–∞–≤ (–º–∏–Ω. 6 –∞–ª–æ–º–∞—Ç)">
      <div class="row" style="margin-top:8px">
        <button class="btn" onclick="changePassword()">–ò–≤–∞–∑ –∫–∞—Ä–¥–∞–Ω</button>
        <button class="btn ghost" onclick="closeModal('changePasswordModal')">–ë–µ–∫–æ—Ä</button>
      </div>
      <div id="changePassMsg" class="muted" style="margin-top:8px"></div>
    </div>
  </div>

  <div class="modal" id="menuModal">
    <div class="card">
      <h3>–ú–µ–Ω—é</h3>
      <ul class="menu-list" id="menuList">
        </ul>
      <div class="row" style="margin-top:8px">
        <button class="btn ghost" onclick="closeModal('menuModal')">–ë–∞—Å—Ç–∞–Ω</button>
      </div>
    </div>
  </div>
  
  <div class="modal" id="aboutModal">
    <div class="card">
      <h3>–û–∏–¥–∏ –±–∞—Ä–Ω–æ–º–∞: KORYOB.TJ</h3>
      <p class="small" style="text-align:justify;">
        –ò–Ω –ª–æ–∏“≥–∞ —è–∫ –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞–∏ —Å–æ–¥–¥–∞ –≤–∞ –º—É–æ—Å–∏—Ä–∏ –∫–æ—Ä—ë–±”£ –º–µ–±–æ—à–∞–¥, –∫–∏ –∏–º–∫–æ–Ω –º–µ–¥–∏“≥–∞–¥ –∫–æ—Ä—ë–±–æ–Ω –±–æ –∫–æ—Ä—Ñ–∞—Ä–º–æ—ë–Ω –º—É—Å—Ç–∞“õ–∏–º–∞–Ω —Ç–∞–≤–∞—Å—Å—É—Ç–∏ —á–∞—Ç –¥–∞—Ä —Ç–∞–º–æ—Å —à–∞–≤–∞–Ω–¥.
      </p>
      <p class="small">
        –ú–∞“õ—Å–∞–¥–∏ –∞—Å–æ—Å”£: –ø–∞–π–≤–∞—Å—Ç –∫–∞—Ä–¥–∞–Ω–∏ –æ–¥–∞–º–æ–Ω –¥–∞—Ä –¢–æ“∑–∏–∫–∏—Å—Ç–æ–Ω –±–æ –∏–º–∫–æ–Ω–∏—è—Ç“≥–æ–∏ –∫–æ—Ä”£.
      </p>
      <p class="small">
        <br>
        **–ù—É—Å—Ö–∞–∏ –ª–æ–∏“≥–∞:** 1.0 
      </p>
      <div class="row" style="margin-top:8px">
        <button class="btn ghost" onclick="closeModal('aboutModal')">–ë–∞—Å—Ç–∞–Ω</button>
      </div>
    </div>
  </div>

  <div class="modal" id="myJobsContainer">
    <div class="card" style="display: flex; flex-direction: column;">
        <div class="job-header">
            <button class="btn ghost" onclick="closeModal('myJobsContainer')" style="font-size: 20px; padding: 5px 10px; margin-right: 10px; background: none; color: white; border: none;">‚Üê</button>
            <h3 style="margin: 0; color: white;">–≠—ä–ª–æ–Ω“≥–æ–∏ –º–∞–Ω</h3>
            <span></span>
        </div>
        <div id="myJobsList" class="job-list-content"></div>
    </div>
  </div>

  <div class="modal" id="jobDetailsModal">
    <div class="card">
      <h3>–¢–∞–≤—Å–∏—Ñ–∏ –ø—É—Ä—Ä–∞</h3>
      <div id="jobDetailsContent"></div>
      <div class="row" style="margin-top:8px">
        <button class="btn ghost" onclick="closeModal('jobDetailsModal')">–ë–∞—Å—Ç–∞–Ω</button>
      </div>
    </div>
  </div>

  <div class="modal" id="chatModal">
    <div class="card" style="max-width:100%; width:100%; height:100%; display:flex; flex-direction:column">
      
      <div class="chat-header">
          <button class="btn ghost" onclick="closeModal('chatModal')" style="font-size: 20px; padding: 5px 10px; margin-right: 10px;">‚Üê</button>
          
          <div id="chatPartnerInfo" style="flex-grow: 1; margin-left: 5px;">
              <h3 id="chatModalTitle" style="margin: 0;">–ß–∞—Ç“≥–æ</h3>
              <p id="chatLastSeen" class="muted" style="margin: 0; font-size: 11px;"></p>
          </div>
          
          <span></span>
      </div>

      <div id="chatList" class="chat-list" style="flex:1; display:block">
        <ul id="chatUsers" style="list-style:none;padding:10px"></ul>
      </div>
      
      <div id="chatWindow" style="flex:1; display:none; flex-direction: column;">
        <div id="chatMessages" class="chat-window"></div>
        <div class="chat-input-area">
          <input id="chatInput" class="input" placeholder="–ü–∞—ë–º –Ω–∞–≤–∏—Å–µ–¥...">
          <button class="btn" onclick="sendMessage()">–§–∏—Ä–∏—Å—Ç–æ–¥–∞–Ω</button>
        </div>
      </div>
      
    </div>
  </div>

  <button class="fab" id="fabAddJob" onclick="openModal('createJobModal')">+</button>
  <button class="fab" id="fabChat" style="bottom:90px" onclick="openModal('chatModal')">üí¨</button>

<script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-database.js"></script>

<script>
/* --------- Firebase Setup & Global Vars ---------- */
const firebaseConfig = {
  apiKey: "AIzaSyBt_fZcc-HPQkFWl5L23i_YBPbzkNm8ZE0",
  authDomain: "koryob-tj.firebaseapp.com",
  databaseURL: "https://koryob-tj-default-rtdb.firebaseio.com",
  projectId: "koryob-tj",
  storageBucket: "koryob-tj.firebasestorage.app",
  messagingSenderId: "851020401703",
  appId: "1:851020401703:web:0063b022dc97ce41165202",
  measurementId: "G-XPWMP1VBGK"
};

// Initialize Firebase
const app = firebase.initializeApp(firebaseConfig);
const auth = app.auth();
const db = app.database();

let currentUser = null; 
let allJobs = [];
let allUsers = {};
let currentChatPartnerEmail = null;


/* --------- storage keys & helpers ---------- */
const DB_USERS = 'users';
const DB_JOBS = 'jobs';
const DB_CHATS = 'chats';
const LS_SESSION = 'koryob_session_v1'; 

function nowYear(){ document.querySelector('#year').innerText = new Date().getFullYear(); }
nowYear();

function saveSession(email){ localStorage.setItem(LS_SESSION, JSON.stringify({ email })); }
function loadSessionEmail(){ 
  const s = localStorage.getItem(LS_SESSION);
  return s ? JSON.parse(s).email : null;
}
function clearSession(){ localStorage.removeItem(LS_SESSION); }

/* --------- modal helpers ---------- */
function openModal(id){ 
  const modal = document.getElementById(id);
  if(modal) modal.style.display = 'flex'; 
  
  if(id === 'chatModal') {
      document.getElementById('chatModalTitle').innerText = '–ß–∞—Ç“≥–æ';
      document.getElementById('chatLastSeen').innerText = ''; // –¢–æ–∑–∞ –∫–∞—Ä–¥–∞–Ω–∏ —Å—Ç–∞—Ç—É—Å –¥–∞—Ä —Ä”Ø–π—Ö–∞—Ç–∏ –∞—Å–æ—Å”£
      document.getElementById('chatList').style.display = 'block';
      document.getElementById('chatWindow').style.display = 'none';
      loadChatList();
      
      markNotificationsAsRead(); 
  }
}
function closeModal(id){ 
  const modal = document.getElementById(id);
  if(modal) modal.style.display = 'none'; 
  if(id === 'chatModal') {
    document.getElementById('chatWindow').style.display = 'none';
    
    if(currentChatPartnerEmail) {
      const chatKey = getChatKey(loadSessionEmail(), currentChatPartnerEmail);
      db.ref(DB_CHATS + '/' + chatKey).off('value');
    }
    currentChatPartnerEmail = null;
  }
  // –¢–æ–∑–∞ –∫–∞—Ä–¥–∞–Ω–∏ –º–æ–¥–∞–ª“≥–æ–∏ –≤–æ—Ä–∏–¥–∫—É–Ω”£
  if (id === 'loginModal') document.getElementById('loginMsg').innerText = '';
  if (id === 'signupModal') document.getElementById('signupMsg').innerText = '';
  if (id === 'forgotPasswordModal') document.getElementById('forgotMsg').innerText = '';
  if (id === 'changePasswordModal') document.getElementById('changePassMsg').innerText = '';
  if (id === 'editNameModal') document.getElementById('editNameMsg').innerText = '';
}

/* --------- nav rendering and authentication state listener ---------- */
const navArea = document.getElementById('navArea');
const fabAdd = document.getElementById('fabAddJob');
const fabChat = document.getElementById('fabChat');

function renderNav(){
  navArea.innerHTML = '';
  if(currentUser && currentUser.email){
    navArea.innerHTML = `
      <div class="badge">${escapeHtml(currentUser.name)} ‚Äî ${currentUser.role === 'korfarmo' ? '–ö–æ—Ä—Ñ–∞—Ä–º–æ' : '–ö–æ—Ä—ë–±'}</div>
      <button id="menuBtn" class="btn ghost">–ú–µ–Ω—é</button>
    `;
    document.getElementById('menuBtn').addEventListener('click', showMenu);
    if(currentUser.role === 'korfarmo') fabAdd.style.display = 'block'; else fabAdd.style.display = 'none';
    fabChat.style.display = 'block';
    
    // update last-seen time
    db.ref(DB_USERS + '/' + encodeURIComponent(currentUser.email).replace(/\./g, '%2E')).update({ lastSeen: Date.now() });
  } else {
    navArea.innerHTML = `
      <button id="openSignupBtn" class="btn">“ö–∞–π–¥ —à—É–¥–∞–Ω</button>
      <button id="openLoginBtn" class="btn ghost">–í–æ—Ä–∏–¥—à–∞–≤”£</button>
    `;
    const signupBtn = document.getElementById('openSignupBtn');
    const loginBtn = document.getElementById('openLoginBtn');
    
    if(signupBtn) signupBtn.addEventListener('click', () => openModal('policyModal'));
    if(loginBtn) loginBtn.addEventListener('click', () => openModal('loginModal'));
    
    fabAdd.style.display = 'none';
    fabChat.style.display = 'none';
  }
}

function acceptPolicyAndOpenSignup() {
    closeModal('policyModal'); 
    openModal('signupModal');  
}

/* --------- Firebase Auth State Listener (Main app loop) ---------- */
auth.onAuthStateChanged(async (user) => {
    if (user) {
        const email = user.email;
        const snapshot = await db.ref(DB_USERS + '/' + encodeURIComponent(email).replace(/\./g, '%2E')).once('value');
        currentUser = snapshot.val();
        if (currentUser) {
            saveSession(email); 
            renderNav();
            listenForJobs();
            listenForUsers();
            listenForNotifications(); 
        } else {
            auth.signOut();
        }
    } else {
        currentUser = null;
        clearSession();
        renderNav();
        renderJobs();
        document.getElementById('notification').style.display = 'none';
    }
});

/* --------- Realtime Database Listeners ---------- */
function listenForUsers() {
    db.ref(DB_USERS).on('value', (snapshot) => {
        allUsers = snapshot.val() || {};
        // –ê–≥–∞—Ä –º–æ–¥–∞–ª“≥–æ–∏ –ü—Ä–æ—Ñ–∏–ª —ë –ß–∞—Ç –∫—É—à–æ–¥–∞ –±–æ—à–∞–Ω–¥, –æ–Ω“≥–æ—Ä–æ –Ω–∞–≤—Å–æ–∑”£ –∫—É–Ω–µ–¥
        if(document.getElementById('chatModal').style.display === 'flex') {
            if(currentChatPartnerEmail) {
                // –ê–≥–∞—Ä –¥–∞—Ä –¥–æ—Ö–∏–ª–∏ —á–∞—Ç –±–æ—à–µ–º, —á–∞—Ç—Ä–æ –Ω–∞–≤—Å–æ–∑”£ –º–µ–∫—É–Ω–µ–º, —Ç–æ —Å—Ç–∞—Ç—É—Å–∏ —à–∞—Ä–∏–∫—Ä–æ –¥–∏“≥–µ–º
                openChat(currentChatPartnerEmail, false); // false - –±–æ—Ä–∏ –¥–∏–≥–∞—Ä —á–∞—ÇRef.on('value') –∏–ª–æ–≤–∞ –Ω–∞–º–µ–∫—É–Ω–∞–¥
            } else {
                loadChatList();
            }
        }
        if(document.getElementById('profileModal').style.display === 'flex') showProfile();
    });
}

function listenForJobs() {
    db.ref(DB_JOBS).on('value', (snapshot) => {
        const jobsObject = snapshot.val();
        allJobs = jobsObject ? Object.keys(jobsObject).map(key => ({ id: key, ...jobsObject[key] })) : [];
        renderJobs(document.getElementById('searchInput').value, document.getElementById('cityFilter').value);
    });
}

function listenForNotifications() {
    if (!currentUser) return;

    const myEncodedEmail = encodeURIComponent(currentUser.email).replace(/\./g, '%2E');
    const notificationRef = db.ref('userNotifications/' + myEncodedEmail); 
    const notificationDiv = document.getElementById('notification');

    notificationRef.on('value', (snapshot) => {
        const hasUnread = snapshot.val();
        if (hasUnread) {
            notificationDiv.style.display = 'block';
        } else {
            notificationDiv.style.display = 'none';
        }
    });
}

async function markNotificationsAsRead() {
    if (!currentUser) return;
    const myEncodedEmail = encodeURIComponent(currentUser.email).replace(/\./g, '%2E');
    await db.ref('userNotifications/' + myEncodedEmail).set(false);
}

/* --------- show menu ---------- */
function showMenu(){
  if(!currentUser) return;
  const menuList = document.getElementById('menuList');
  menuList.innerHTML = `
    <li><button class="btn ghost" onclick="showProfile(); closeModal('menuModal')">–ü—Ä–æ—Ñ–∏–ª–∏ –º–∞–Ω</button></li>
    ${currentUser.role === 'korfarmo' ? '<li><button class="btn ghost" onclick="openModal(\'createJobModal\'); closeModal(\'menuModal\')">–ò–ª–æ–≤–∞–∏ —ç—ä–ª–æ–Ω</button></li>' : ''}
    ${currentUser.role === 'korfarmo' ? '<li><button class="btn ghost" onclick="showMyJobs(); closeModal(\'menuModal\')">–≠—ä–ª–æ–Ω“≥–æ–∏ –º–∞–Ω</button></li>' : ''}
    <li><button class="btn ghost" onclick="openModal('chatModal'); closeModal('menuModal')">–ß–∞—Ç</button></li>
    <li><button class="btn ghost" onclick="openModal('aboutModal'); closeModal(\'menuModal\')">–û–∏–¥–∏ –±–∞—Ä–Ω–æ–º–∞</button></li>
    <li><button class="btn danger" onclick="logout(); closeModal('menuModal')">–ë–∞—Ä–æ–º–∞–¥</button></li>
  `;
  openModal('menuModal');
}

/* --------- profile, myJobs, jobDetails (–¢–∞“ì–π–∏—Ä—ë—Ñ—Ç–∞) ---------- */
function showProfile(){
  if(!currentUser) return;
  
  const roleText = currentUser.role === 'korfarmo' ? '–ö–æ—Ä—Ñ–∞—Ä–º–æ' : '–ö–æ—Ä“∑—É–π';
  const initial = currentUser.name ? currentUser.name[0].toUpperCase() : '?';

  // Last Seen logic
  const lastSeen = currentUser.lastSeen;
  const isOnline = lastSeen && (Date.now() - lastSeen < 5 * 60 * 1000); // 5 –¥–∞“õ–∏“õ–∞
  const lastSeenText = isOnline ? 
      '<span style="color: var(--online); font-weight: bold;">–û–Ω–ª–∞–π–Ω</span>' : 
      (lastSeen ? new Date(lastSeen).toLocaleString('tg-TJ') : '‚Äî');
      
  document.getElementById('profileInitial').innerText = initial;
  document.getElementById('profileDisplayName').innerText = escapeHtml(currentUser.name);
  document.getElementById('profileDisplayRole').innerText = roleText;

  const profileInfo = document.getElementById('profileInfoContent');
  profileInfo.innerHTML = `
    <div class="profile-item">
        <span class="profile-label">–ü–æ—á—Ç–∞–∏ —ç–ª–µ–∫—Ç—Ä–æ–Ω”£</span>
        <span class="profile-value">${escapeHtml(currentUser.email)}</span>
    </div>
    <div class="profile-item">
        <span class="profile-label">–ù–∞“õ—à</span>
        <span class="profile-value">${roleText}</span>
    </div>
    <div class="profile-item">
        <span class="profile-label">–û—Ö–∏—Ä–∏–Ω –¥–∏–¥–∞–Ω</span>
        <span class="profile-value">${lastSeenText}</span>
    </div>
  `;
  openModal('profileModal');
}

// –§—É–Ω–∫—Å–∏—è–∏ –Ω–∞–≤ –±–∞—Ä–æ–∏ –∫—É—à–æ–¥–∞–Ω–∏ –º–æ–¥–∞–ª–∏ —Ç–∞“≥—Ä–∏—Ä–∏ –Ω–æ–º
function openEditNameModal() {
    if (!currentUser) return;
    document.getElementById('editNameInput').value = currentUser.name;
    document.getElementById('editNameMsg').innerText = '';
    closeModal('profileModal');
    openModal('editNameModal');
}

// –§—É–Ω–∫—Å–∏—è–∏ –Ω–∞–≤ –±–∞—Ä–æ–∏ —Ç–∞“ì–π–∏—Ä–∏ –Ω–æ–º
async function updateProfileName() {
    const newName = document.getElementById('editNameInput').value.trim();
    const editNameMsg = document.getElementById('editNameMsg');

    if (!newName || newName.length < 3) {
        editNameMsg.innerText = '–ù–æ–º –±–æ—è–¥ –Ω–∞ –∫–∞–º—Ç–∞—Ä –∞–∑ 3 –∞–ª–æ–º–∞—Ç –±–æ—à–∞–¥.';
        return;
    }

    editNameMsg.innerText = '–ù–∞–≤—Å–æ–∑”£ –º–µ—à–∞–≤–∞–¥...';
    
    try {
        const userRef = db.ref(DB_USERS + '/' + encodeURIComponent(currentUser.email).replace(/\./g, '%2E'));
        await userRef.update({ name: newName });

        // Update current user object and re-render navigation
        currentUser.name = newName;
        renderNav();

        editNameMsg.innerText = '–ù–æ–º –±–æ–º—É–≤–∞—Ñ—Ñ–∞“õ–∏—è—Ç —Ç–∞“ì–π–∏—Ä –¥–æ–¥–∞ —à—É–¥!';
        
        // –ù–∞–≤—Å–æ–∑–∏–∏ –Ω–æ–º–∏ —ç—ä–ª–æ–Ω“≥–æ–∏ –Ω–∞—à—Ä—à—É–¥–∞–∏ –∫–æ—Ä—Ñ–∞—Ä–º–æ (–∞–≥–∞—Ä –ª–æ–∑–∏–º –±–æ—à–∞–¥)
        if (currentUser.role === 'korfarmo') {
            const updates = {};
            allJobs.filter(job => job.postedEmail === currentUser.email).forEach(job => {
                updates[job.id + '/postedBy'] = newName;
            });
            if (Object.keys(updates).length > 0) {
                await db.ref(DB_JOBS).update(updates);
            }
        }

        setTimeout(() => {
            closeModal('editNameModal');
            showProfile(); // –ë–∞—Ä–≥–∞—à—Ç–∞–Ω –±–∞ –ø—Ä–æ—Ñ–∏–ª–∏ –Ω–∞–≤—Å–æ–∑–∏—à—É–¥–∞
        }, 1000);

    } catch (error) {
        editNameMsg.innerText = '–•–∞—Ç–æ–∏ –Ω–∞–≤—Å–æ–∑”£: ' + error.message;
    }
}


function showMyJobs(){
  if(!currentUser || currentUser.role !== 'korfarmo') return;
  const myJobsList = document.getElementById('myJobsList');
  myJobsList.innerHTML = '';
  const myJobs = allJobs.filter(job => job.postedEmail === currentUser.email);

  if(myJobs.length === 0){
    myJobsList.innerHTML = '<p class="muted" style="text-align: center;">–®—É–º–æ —ç—ä–ª–æ–Ω“≥–æ –Ω–∞–¥–æ—Ä–µ–¥.</p>';
  } else {
    myJobs.forEach(job => {
      const shortDesc = job.desc && job.desc.length > 100 ? job.desc.slice(0, 100) + '...' : job.desc || '';
      const div = document.createElement('div');
      div.className = 'job-card';
      div.innerHTML = `
        <h3>${escapeHtml(job.title)}</h3>
        <p class="small"><b>–®–∞“≥—Ä:</b> ${escapeHtml(job.city)}</p>
        <p class="small"><b>–ú–∞–æ—à:</b> ${escapeHtml(job.salary || '‚Äî')}</p>
        <p class="small"><b>–¢–∞–≤—Å–∏—Ñ:</b> ${escapeHtml(shortDesc)}</p>
        <p class="muted">–°—Ç–∞—Ç—É—Å: ${job.active ? '–§–∞—ä–æ–ª' : '“í–∞–π—Ä–∏—Ñ–∞—ä–æ–ª'} | üëÅ –î–∏–¥–∞ —à—É–¥: ${job.views || 0}</p>
        <div class="row">
          <button class="btn ghost" onclick="showJobDetails('${job.id}')">–ù–∏–≥–∞—Ä–∏—Å—Ç–∞–Ω–∏ –ø—É—Ä—Ä–∞</button>
          ${job.active ? `<button class="btn warn" onclick="markFound('${job.id}'); showMyJobs();">‚úÖ –ö–æ—Ä–≥–∞—Ä —ë—Ñ—Ç —à—É–¥</button>` : ''}
          <button class="btn danger" onclick="deleteJob('${job.id}'); showMyJobs();">‚ùå “≤–∞–∑—Ñ</button>
        </div>
      `;
      myJobsList.appendChild(div);
    });
  }
  openModal('myJobsContainer');
}

async function showJobDetails(id){
  // ----------------------------------------------------
  // –ò–õ–û–í–ê–ò –ú–ê“≤–î–£–î–ò–Ø–¢ –ë–ê–†–û–ò –ö–û–†–ë–ê–†–û–ù–ò –í–û–†–ò–î–ù–ê–®–£–î–ê
  if (!currentUser) {
      // –ò—Å—Ç–∏—Ñ–æ–¥–∞–∏ confirm –±–∞—Ä–æ–∏ –∏–Ω—Ç–∏—Ö–æ–±
      const userChoice = confirm("–ë–∞—Ä–æ–∏ –¥–∏–¥–∞–Ω–∏ —Ç–∞—Ñ—Å–∏–ª–æ—Ç–∏ –ø—É—Ä—Ä–∞–∏ —ç—ä–ª–æ–Ω, –ª—É—Ç—Ñ–∞–Ω –≤–æ—Ä–∏–¥ —à–∞–≤–µ–¥ —ë —Å–∞–±—Ç–∏ –Ω–æ–º –∫—É–Ω–µ–¥.\n\n–ë–∞—Ä–æ–∏ '“ö–∞–π–¥ —à—É–¥–∞–Ω' OK-—Ä–æ, –±–∞—Ä–æ–∏ '–í–æ—Ä–∏–¥—à–∞–≤”£' –ë–µ–∫–æ—Ä-—Ä–æ –ø–∞—Ö—à –∫—É–Ω–µ–¥.");
      
      if (userChoice) {
          // OK: “ö–∞–π–¥ —à—É–¥–∞–Ω (PolicyModal->SignupModal)
          openModal('policyModal');
      } else {
          // –ë–µ–∫–æ—Ä: –í–æ—Ä–∏–¥—à–∞–≤”£
          openModal('loginModal');
      }
      return; 
  }
  // ----------------------------------------------------

  const job = allJobs.find(j => j.id === id);
  if(!job) return;

  if(currentUser && currentUser.email !== job.postedEmail){
      await db.ref(DB_JOBS + '/' + id + '/views').transaction((current) => {
          return (current || 0) + 1;
      });
  }

  const updatedJob = allJobs.find(j => j.id === id) || job;
  
  const detailsContent = document.getElementById('jobDetailsContent');
  detailsContent.innerHTML = `
    <h3>${escapeHtml(updatedJob.title)}</h3>
    <p class="small"><b>–®–∏—Ä–∫–∞—Ç:</b> ${escapeHtml(updatedJob.company)} ‚Äî ${escapeHtml(updatedJob.city)}</p>
    <p class="small"><b>–ú–∞–æ—à:</b> ${escapeHtml(updatedJob.salary || '‚Äî')}</p>
    <p class="small"><b>–°–æ–∞—Ç“≥–æ:</b> ${escapeHtml(updatedJob.hours || '‚Äî')}</p>
    <p class="small"><b>–¢–µ–ª–µ—Ñ–æ–Ω:</b> ${escapeHtml(updatedJob.phone || '‚Äî')}</p>
    <p class="small"><b>–°–∏–Ω–Ω—É —Å–æ–ª:</b> ${escapeHtml(updatedJob.age || '‚Äî')}</p>
    <p class="small"><b>“∂–∏–Ω—Å:</b> ${escapeHtml(updatedJob.gender)}</p>
    <p class="small"><b>–ù–∞—à—Ä–∫—É–Ω–∞–Ω–¥–∞:</b> ${escapeHtml(updatedJob.postedBy)}</p>
    <p class="small"><b>–°–∞–Ω–∞–∏ –Ω–∞—à—Ä:</b> ${formatPostDate(updatedJob.postedAt)}</p> <p class="small"><b>–¢–∞–≤—Å–∏—Ñ:</b> ${escapeHtml(updatedJob.desc || '‚Äî')}</p>
    ${currentUser && currentUser.email !== updatedJob.postedEmail ? 
      `<button class="btn" onclick="startChatWith('${updatedJob.postedEmail}'); closeModal('jobDetailsModal')">–ß–∞—Ç –±–æ –∫–æ—Ä—Ñ–∞—Ä–º–æ</button>` : ''}
  `;
  openModal('jobDetailsModal');
}

function deleteJob(id){
  if(!confirm('“≤–∞–∑—Ñ?')) return;
  db.ref(DB_JOBS + '/' + id).remove()
    .catch(error => { alert('–•–∞—Ç–æ–∏ “≥–∞–∑—Ñ: ' + error.message); });
  // showMyJobs() –¥–∞—Ä —Ç—É–≥–º–∞ –¥–∞—ä–≤–∞—Ç –∫–∞—Ä–¥–∞ –º–µ—à–∞–≤–∞–¥
}

function markFound(id){
  if(!confirm('“í–∞–π—Ä–∏—Ñ–∞—ä–æ–ª?')) return;
  db.ref(DB_JOBS + '/' + id).update({ active: false })
    .then(() => { alert('“í–∞–π—Ä–∏—Ñ–∞—ä–æ–ª —à—É–¥.'); })
    .catch(error => { alert('–•–∞—Ç–æ–∏ “ì–∞–π—Ä–∏—Ñ–∞—ä–æ–ª –∫–∞—Ä–¥–∞–Ω: ' + error.message); });
  // showMyJobs() –¥–∞—Ä —Ç—É–≥–º–∞ –¥–∞—ä–≤–∞—Ç –∫–∞—Ä–¥–∞ –º–µ—à–∞–≤–∞–¥
}

/* --------- logout, signup, login, createJob, renderJobs (–ë–æ —Ç–∞“ì–π–∏—Ä–æ—Ç–∏ signup) ---------- */
function logout(){
  auth.signOut();
  currentUser = null;
  clearSession();
  renderNav();
  renderJobs();
}

// **–§–£–ù–ö–°–ò–Ø–ò SIGNUP –ù–ê–í–°–û–ó”¢ –®–£–î**
async function signup(){
  const name = document.getElementById('signupName').value.trim();
  const email = document.getElementById('signupEmail').value.trim().toLowerCase();
  const pass = document.getElementById('signupPassword').value;
  const role = document.querySelector('input[name="role"]:checked')?.value;
  const signupMsg = document.getElementById('signupMsg');

  if(!name || name.length < 3){ signupMsg.innerText = '–ù–æ–º –±–æ—è–¥ –Ω–∞ –∫–∞–º—Ç–∞—Ä –∞–∑ 3 –∞–ª–æ–º–∞—Ç –±–æ—à–∞–¥'; return; }
  if(!email || !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)){ signupMsg.innerText = 'Email –Ω–æ–¥—É—Ä—É—Å—Ç –∞—Å—Ç'; return; }
  if(!pass || pass.length < 6){ signupMsg.innerText = '–ü–∞—Ä–æ–ª –±–æ—è–¥ –Ω–∞ –∫–∞–º—Ç–∞—Ä –∞–∑ 6 –∞–ª–æ–º–∞—Ç –±–æ—à–∞–¥'; return; }
  if(!role){ signupMsg.innerText = '–†–æ–ª—Ä–æ –∏–Ω—Ç–∏—Ö–æ–± –∫—É–Ω–µ–¥'; return; }

  try {
    const userCredential = await auth.createUserWithEmailAndPassword(email, pass);
    const user = userCredential.user;
    
    const userData = { name, email, role, createdAt: new Date().toISOString(), lastSeen: Date.now() }; 
    await db.ref(DB_USERS + '/' + encodeURIComponent(email).replace(/\./g, '%2E')).set(userData);

    currentUser = userData;
    saveSession(email);
    closeModal('signupModal');
    renderNav();
    renderJobs();
    alert('–°–∞–±—Ç —à—É–¥–µ–¥.');
    
    ['signupName','signupEmail','signupPassword'].forEach(id => document.getElementById(id).value = '');
    signupMsg.innerText = '';
  } catch (error) {
    let errorMessage = '–•–∞—Ç–æ–∏ —Å–∞–±—Ç: ' + error.message;
    if (error.code === 'auth/email-already-in-use') {
        errorMessage = '–ò–Ω –ø–æ—á—Ç–∞–∏ —ç–ª–µ–∫—Ç—Ä–æ–Ω”£ (email) –∞–ª–ª–∞–∫–∞–π —Å–∞–±—Ç —à—É–¥–∞–∞—Å—Ç.';
    } else if (error.code === 'auth/invalid-email') {
        errorMessage = '–§–æ—Ä–º–∞—Ç–∏ –ø–æ—á—Ç–∞–∏ —ç–ª–µ–∫—Ç—Ä–æ–Ω”£ –Ω–æ–¥—É—Ä—É—Å—Ç –∞—Å—Ç.';
    }
    signupMsg.innerText = errorMessage;
  }
}

async function login(){
  const email = document.getElementById('loginEmail').value.trim().toLowerCase();
  const pass = document.getElementById('loginPassword').value;
  const loginMsg = document.getElementById('loginMsg');

  if(!email || !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)){ loginMsg.innerText = 'Email –Ω–æ–¥—É—Ä—É—Å—Ç –∞—Å—Ç'; return; }
  if(!pass || pass.length < 6){ loginMsg.innerText = '–ü–∞—Ä–æ–ª –±–æ—è–¥ –Ω–∞ –∫–∞–º—Ç–∞—Ä –∞–∑ 6 –∞–ª–æ–º–∞—Ç –±–æ—à–∞–¥'; return; }

  try {
    await auth.signInWithEmailAndPassword(email, pass);
    
    closeModal('loginModal');
    
    ['loginEmail','loginPassword'].forEach(id => document.getElementById(id).value = '');
    loginMsg.innerText = '';
  } catch (error) {
    loginMsg.innerText = '–•–∞—Ç–æ–∏ –≤–æ—Ä–∏–¥—à–∞–≤”£: –ü–æ—á—Ç–∞ —ë –ø–∞—Ä–æ–ª –Ω–æ–¥—É—Ä—É—Å—Ç –∞—Å—Ç';
  }
}

// –§—É–Ω–∫—Å–∏—è–∏ –Ω–∞–≤: –ë–∞—Ä“õ–∞—Ä–æ—Ä–∫—É–Ω–∏–∏ –ø–∞—Ä–æ–ª (–ù–ê–í–°–û–ó”¢ –®–£–î)
async function forgotPassword() {
    const email = document.getElementById('forgotEmail').value.trim().toLowerCase();
    const forgotMsg = document.getElementById('forgotMsg');

    if(!email || !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)){ 
        forgotMsg.innerText = '–ü–æ—á—Ç–∞–∏ —ç–ª–µ–∫—Ç—Ä–æ–Ω–∏–∏ –¥—É—Ä—É—Å—Ç—Ä–æ –≤–æ—Ä–∏–¥ –∫—É–Ω–µ–¥.'; 
        return; 
    }
    
    forgotMsg.innerText = '–ò—Ä—Å–æ–ª –º–µ—à–∞–≤–∞–¥...';
    
    // **–ú–∞—Ç–Ω–∏ –æ–≥–æ“≥–∏–∏ –∞–º–Ω–∏—è—Ç”£ –≤–∞ –º—É–∫–∞–º–º–∞–ª—à—É–¥–∞**
    const securityMessage = `–ê–≥–∞—Ä –∏–Ω –ø–æ—á—Ç–∞ –¥–∞—Ä —Å–∏—Å—Ç–µ–º–∞–∏ –º–æ –º–∞–≤“∑—É–¥ –±–æ—à–∞–¥, –ø–∞–π–≤–∞–Ω–¥–∏ —Ç–∞“ì–π–∏—Ä–∏ –ø–∞—Ä–æ–ª –±–∞ ${email} —Ñ–∏—Ä–∏—Å—Ç–æ–¥–∞ —à—É–¥. (–õ—É—Ç—Ñ–∞–Ω, –ø–∞—ë–º–¥–æ–Ω–∏ —Å–ø–∞–º—Ä–æ “≥–∞–º —Ç–∞—Ñ—Ç–∏—à –∫—É–Ω–µ–¥).`;
    
    try {
        await auth.sendPasswordResetEmail(email);
        
        forgotMsg.innerText = securityMessage;
        
        document.getElementById('forgotEmail').value = '';
        setTimeout(() => closeModal('forgotPasswordModal'), 4000); 
    } catch (error) {
        console.error("–•–∞—Ç–æ–∏ Firebase (–∞–º–Ω–∏—è—Ç”£ –ø–∏–Ω“≥–æ–Ω):", error);
        forgotMsg.innerText = securityMessage;
        document.getElementById('forgotEmail').value = '';
        setTimeout(() => closeModal('forgotPasswordModal'), 4000);
    }
}

// –§—É–Ω–∫—Å–∏—è–∏ –Ω–∞–≤: –ò–≤–∞–∑ –∫–∞—Ä–¥–∞–Ω–∏ –ø–∞—Ä–æ–ª
async function changePassword() {
    const currentPass = document.getElementById('currentPassword').value;
    const newPass = document.getElementById('newPassword').value;
    const changePassMsg = document.getElementById('changePassMsg');

    if(!currentPass || !newPass){ changePassMsg.innerText = '“≤–∞–º–∞–∏ –º–∞–π–¥–æ–Ω“≥–æ—Ä–æ –ø—É—Ä –∫—É–Ω–µ–¥.'; return; }
    if(newPass.length < 6){ changePassMsg.innerText = '–ü–∞—Ä–æ–ª–∏ –Ω–∞–≤ –±–æ—è–¥ –Ω–∞ –∫–∞–º—Ç–∞—Ä –∞–∑ 6 –∞–ª–æ–º–∞—Ç –±–æ—à–∞–¥.'; return; }
    
    changePassMsg.innerText = '–¢–∞—Å–¥–∏“õ –≤–∞ –∏–≤–∞–∑—à–∞–≤”£...';
    
    try {
        // 1. –°–∞–Ω“∑–∏—à–∏ –ø–∞—Ä–æ–ª–∏ –ø–µ—à–∏–Ω–∞
        const credential = firebase.auth.EmailAuthProvider.credential(currentUser.email, currentPass);
        await auth.currentUser.reauthenticateWithCredential(credential);

        // 2. –ò–≤–∞–∑ –∫–∞—Ä–¥–∞–Ω–∏ –ø–∞—Ä–æ–ª
        await auth.currentUser.updatePassword(newPass);
        
        changePassMsg.innerText = '–ü–∞—Ä–æ–ª –±–æ–º—É–≤–∞—Ñ—Ñ–∞“õ–∏—è—Ç –∏–≤–∞–∑ —à—É–¥!';
        
        // –¢–æ–∑–∞ –∫–∞—Ä–¥–∞–Ω–∏ –º–∞–π–¥–æ–Ω“≥–æ
        document.getElementById('currentPassword').value = '';
        document.getElementById('newPassword').value = '';
        
        setTimeout(() => closeModal('changePasswordModal'), 2000);
    } catch (error) {
        changePassMsg.innerText = '–•–∞—Ç–æ–∏ –∏–≤–∞–∑—à–∞–≤”£: ' + (error.code === 'auth/wrong-password' ? '–ü–∞—Ä–æ–ª–∏ –ø–µ—à–∏–Ω–∞ –Ω–æ–¥—É—Ä—É—Å—Ç –∞—Å—Ç' : error.message);
    }
}

async function createJob(){
  if(!currentUser || currentUser.role !== 'korfarmo'){ document.getElementById('createJobMsg').innerText = '–§–∞“õ–∞—Ç –∫–æ—Ä—Ñ–∞—Ä–º–æ –º–µ—Ç–∞–≤–æ–Ω–∞–¥ —ç—ä–ª–æ–Ω –≥—É–∑–æ—Ä–∞–¥.'; return; }

  const hasActiveJob = allJobs.some(job => job.postedEmail === currentUser.email && job.active);
  if(hasActiveJob){ document.getElementById('createJobMsg').innerText = '–®—É–º–æ –∞–ª–ª–∞–∫–∞–π —è–∫ —ç—ä–ª–æ–Ω–∏ —Ñ–∞—ä–æ–ª –¥–æ—Ä–µ–¥.'; return; }

  const title = document.getElementById('jobTitle').value.trim();
  const company = document.getElementById('jobCompany').value.trim();
  const city = document.getElementById('jobCity').value.trim();
  const salary = document.getElementById('jobSalary').value.trim();
  const hours = document.getElementById('jobHours').value.trim();
  const age = document.getElementById('jobAge').value.trim();
  const phone = document.getElementById('jobPhone').value.trim();
  const gender = document.getElementById('jobGender').value;
  const desc = document.getElementById('jobDesc').value.trim();

  if(!title || !company || !city){ document.getElementById('createJobMsg').innerText = '–ú–∞–π–¥–æ–Ω“≥–æ–∏ –∞—Å–æ—Å–∏—Ä–æ –ø—É—Ä –∫—É–Ω–µ–¥.'; return; }

  const newJob = {
    title, company, city, salary, hours, age, phone, gender, desc,
    postedBy: currentUser.name,
    postedEmail: currentUser.email,
    postedAt: new Date().toISOString(),
    views: 0,
    active: true
  };
  
  try {
    await db.ref(DB_JOBS).push(newJob);

    ['jobTitle','jobCompany','jobCity','jobSalary','jobHours','jobAge','jobPhone','jobDesc'].forEach(id => document.getElementById(id).value='');
    document.getElementById('jobGender').value = '–§–∞—Ä“õ –Ω–∞–¥–æ—Ä–∞–¥';
    document.getElementById('createJobMsg').innerText = '';
    closeModal('createJobModal');
  } catch (error) {
    document.getElementById('createJobMsg').innerText = '–•–∞—Ç–æ–∏ –Ω–∞—à—Ä: ' + error.message;
  }
}

// **–§–£–ù–ö–°–ò–Ø–ò –ù–ê–í–ò –Å–†–ò–†–ê–°–û–ù (–ê–∑ isoString –±–∞ –†”Ø–∑/–ú–æ“≥/–°–æ–ª —Ç–∞–±–¥–∏–ª –º–µ–¥–∏“≥–∞–¥)**
function formatPostDate(isoString) {
    if (!isoString) return '‚Äî';
    const date = new Date(isoString);
    const day = String(date.getDate()).padStart(2, '0');
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const year = date.getFullYear();
    return `${day}/${month}/${year}`;
}


// **–§–£–ù–ö–°–ò–Ø–ò NAVSOZII RENDERJOBS (–±–æ –º–∞“≥–¥—É–¥–∏—è—Ç–∏ 5-—ç—ä–ª–æ–Ω–∞)**
async function renderJobs(query='', city=''){
  const list = document.getElementById('jobList');
  list.innerHTML = '';
  
  const filteredJobs = allJobs.filter(job => {
    if(!job.active) return false;
    const combined = (job.title+' '+job.company+' '+job.city+' '+job.desc+' '+job.age+' '+job.gender+' '+job.hours+' '+job.phone).toLowerCase();
    if(query.trim().toLowerCase() && !combined.includes(query.trim().toLowerCase())) return false;
    if(city.trim() && job.city !== city.trim()) return false;
    return true;
  });

  if(filteredJobs.length === 0){ 
    list.innerHTML = '<p class="muted">–≠—ä–ª–æ–Ω“≥–æ –Ω–µ—Å—Ç.</p>'; 
    return; 
  }
  
  // –ú–∞“≥–¥—É–¥–∏—è—Ç—Ä–æ —Ç–∞—Ç–±–∏“õ –º–µ–∫—É–Ω–µ–º
  const isUserLoggedIn = !!currentUser;
  const jobsToRender = isUserLoggedIn ? filteredJobs : filteredJobs.slice(0, 5);
  
  jobsToRender.forEach(job => {
    const shortDesc = job.desc && job.desc.length > 100 ? job.desc.slice(0, 100) + '...' : job.desc || '';
    const postDate = formatPostDate(job.postedAt); // –ò—Å—Ç–∏—Ñ–æ–¥–∞–∏ —Ñ—É–Ω–∫—Å–∏—è–∏ –Ω–∞–≤
    
    const div = document.createElement('div');
    div.className = 'job-card';
    div.innerHTML = `
      <h3>${escapeHtml(job.title)}</h3>
      <p class="small"><b>–®–∏—Ä–∫–∞—Ç:</b> ${escapeHtml(job.company)} ‚Äî ${escapeHtml(job.city)}</p>
      <p class="small"><b>–ú–∞–æ—à:</b> ${escapeHtml(job.salary || '‚Äî')}</p>
      <p class="small"><b>–ù–∞—à—Ä–∫—É–Ω–∞–Ω–¥–∞:</b> ${escapeHtml(job.postedBy)}</p>
      <p class="small"><b>–°–∞–Ω–∞–∏ –Ω–∞—à—Ä:</b> ${postDate}</p> <p class="muted">üëÅ –î–∏–¥–∞ —à—É–¥: ${job.views || 0}</p>
      <p style="margin-top:8px"><b>–¢–∞–≤—Å–∏—Ñ:</b> ${escapeHtml(shortDesc)}</p>
      <div class="row">
        <button class="btn ghost" onclick="showJobDetails('${job.id}')">–ù–∏–≥–∞—Ä–∏—Å—Ç–∞–Ω–∏ –ø—É—Ä—Ä–∞</button>
        
        ${currentUser && currentUser.role === 'korjob' && currentUser.email !== job.postedEmail ? 
          `<button class="btn" onclick="startChatWith('${job.postedEmail}')">–ß–∞—Ç –±–æ –∫–æ—Ä—Ñ–∞—Ä–º–æ</button>` : ''}
        
      </div>
    `;

    if(currentUser && currentUser.email === job.postedEmail){
      const controls = document.createElement('div');
      controls.className = 'row';
      controls.innerHTML = `
        <button class="btn warn" onclick="markFound('${job.id}'); showMyJobs();">‚úÖ –ö–æ—Ä–≥–∞—Ä —ë—Ñ—Ç —à—É–¥</button>
        <button class="btn danger" onclick="deleteJob('${job.id}'); showMyJobs();">‚ùå “≤–∞–∑—Ñ</button>
      `;
      div.querySelector('.row').insertAdjacentElement('afterend', controls);
    }

    list.appendChild(div);
  });
  
  // –ê–≥–∞—Ä –≤–æ—Ä–∏–¥–Ω–∞—à—É–¥–∞ –±–æ—à–∞–¥ –≤–∞ —ç—ä–ª–æ–Ω“≥–æ –∑–∏—ë–¥ –±–æ—à–∞–Ω–¥, –æ–≥–æ“≥–∏—Ä–æ –Ω–∏—à–æ–Ω –º–µ–¥–∏“≥–µ–º
  if (!isUserLoggedIn && filteredJobs.length > 5) {
    const warning = document.createElement('div');
    warning.style.textAlign = 'center';
    warning.style.padding = '15px';
    warning.style.marginTop = '20px';
    warning.style.marginBottom = '20px';
    warning.style.background = '#ffe0b2'; 
    warning.style.borderRadius = '8px';
    warning.innerHTML = `
      <p style="margin: 0; font-weight: bold; color: #cc5500;">
        –ë–∞—Ä–æ–∏ –¥–∏–¥–∞–Ω–∏ “≥–∞–º–∞–∏ ${filteredJobs.length} —ç—ä–ª–æ–Ω –≤–∞ –¥–∞—Å—Ç—Ä–∞—Å”£ –±–∞ —á–∞—Ç –ª—É—Ç—Ñ–∞–Ω 
        <a href="#" onclick="openModal('policyModal')" style="color:var(--blue); text-decoration: underline;">—Å–∞–±—Ç–∏ –Ω–æ–º –∫—É–Ω–µ–¥</a>.
      </p>
    `;
    list.appendChild(warning);
  }
}

/* --------- chat functionality (–ù–ê–í–°–û–ó”¢ –®–£–î) ---------- */
function getChatKey(email1, email2) {
    return [encodeURIComponent(email1).replace(/\./g, '%2E'), encodeURIComponent(email2).replace(/\./g, '%2E')].sort().join('--');
}

function getTimestamp(isoString) {
    return isoString ? new Date(isoString).getTime() : 0; 
}

// –§—É–Ω–∫—Å–∏—è–∏ –Ω–∞–≤: –ù–∞–º–æ–∏—à–∏ –≤–∞“õ—Ç–∏ –æ—Ö–∏—Ä–∏–Ω–∏ —Ñ–∞—ä–æ–ª–∏—è—Ç
function formatLastSeen(timestamp) {
    if (!timestamp) return '‚Äî';
    const now = Date.now();
    const diffSeconds = Math.floor((now - timestamp) / 1000);
    const diffMinutes = Math.floor(diffSeconds / 60);
    const diffHours = Math.floor(diffMinutes / 60);

    if (diffMinutes < 5) return '–û–Ω–ª–∞–π–Ω'; 
    if (diffMinutes < 60) return `${diffMinutes} –¥–∞“õ. –ø–µ—à`;
    if (diffHours < 24) return `${diffHours} —Å–æ–∞—Ç –ø–µ—à`;
    
    const date = new Date(timestamp);
    const today = new Date(now).toDateString();
    const yesterday = new Date(now - 86400000).toDateString(); 
    
    if (date.toDateString() === yesterday) return '–î–∏—Ä”Ø–∑'; 
    
    return date.toLocaleDateString('tg-TJ');
}

// –§—É–Ω–∫—Å–∏—è–∏ –Ω–∞–≤: –ú–∞—Ä–∫ –∫–∞—Ä–¥–∞–Ω–∏ –ø–∞—ë–º“≥–æ “≥–∞–º—á—É–Ω "–î–∏–¥–∞ —à—É–¥"
function markMessagesAsRead(chatKey) {
    if (!currentUser || !chatKey) return;
    
    // –ú–æ —Ç–∞–Ω“≥–æ –ø–∞—ë–º“≥–æ–∏ –∞–∑ “∑–æ–Ω–∏–±–∏ —à–∞—Ä–∏–∫ —Ñ–∏—Ä–∏—Å—Ç–æ–¥–∞—à—É–¥–∞—Ä–æ –º–∞—Ä–∫ –º–µ–∫—É–Ω–µ–º
    db.ref(DB_CHATS + '/' + chatKey).once('value', (snapshot) => {
        const messages = snapshot.val() || {};
        const updates = {};
        
        // “≤–∞—Ä —è–∫ –ø–∞—ë–º–µ—Ä–æ, –∫–∏ –∞–∑ “∑–æ–Ω–∏–±–∏ –®–ê–†–ò–ö —Ñ–∏—Ä–∏—Å—Ç–æ–¥–∞ —à—É–¥–∞–∞—Å—Ç –≤–∞ "read" –Ω–∞–¥–æ—Ä–∞–¥, –Ω–∞–≤—Å–æ–∑”£ –º–µ–∫—É–Ω–µ–º
        for (const messageId in messages) {
            const msg = messages[messageId];
            if (msg.sender === currentChatPartnerEmail && !msg.read) {
                updates[messageId + '/read'] = true;
            }
        }
        
        if (Object.keys(updates).length > 0) {
            db.ref(DB_CHATS + '/' + chatKey).update(updates);
        }
    });
    
    // –ê–∑ –±–∞–π–Ω –±—É—Ä–¥–∞–Ω–∏ –æ–≥–æ“≥–∏–∏ "–ø–∞—ë–º–∏ –Ω–∞–≤" –±–∞—Ä–æ–∏ —Ö—É–¥
    markNotificationsAsRead();
}


async function loadChatList(){
  if(!currentUser) return;
  const chatUsers = document.getElementById('chatUsers');
  chatUsers.innerHTML = '';
  
  const myEmailEncoded = encodeURIComponent(currentUser.email).replace(/\./g, '%2E');
  const chatsSnapshot = await db.ref(DB_CHATS).once('value');
  const allChats = chatsSnapshot.val() || {};
  
  const chatPartners = {}; // { partnerEmail: { lastMessage: messageObject, chatKey: string } }

  // 1. “∂–∞–º—ä–æ–≤–∞—Ä–∏–∏ “≥–∞–º–∞–∏ “≥–∞–º—Å”Ø“≥–±–∞—Ç–æ–Ω –≤–∞ –ø–∞—ë–º–∏ –æ—Ö–∏—Ä–∏–Ω
  for (const chatKey in allChats) {
      if (chatKey.includes(myEmailEncoded)) {
          const [emailAEncoded, emailBEncoded] = chatKey.split('--');
          const partnerEmailEncoded = emailAEncoded === myEmailEncoded ? emailBEncoded : emailAEncoded;
          const partnerEmail = decodeURIComponent(partnerEmailEncoded).replace(/%2E/g, '.');

          const messages = Object.values(allChats[chatKey]);
          const lastMessage = messages[messages.length - 1];
          
          if(lastMessage) {
            chatPartners[partnerEmail] = { lastMessage, chatKey };
          }
      }
  }

  // 2. –°–æ—Ä—Ç (–¢–∞—Ä—Ç–∏–±) –∞–∑ —Ä”Ø–∏ –≤–∞“õ—Ç–∏ –ø–∞—ë–º–∏ –æ—Ö–∏—Ä–∏–Ω (–û—Ö–∏—Ä–∏–Ω –¥–∞—Ä –±–æ–ª–æ)
  const sortedPartners = Object.keys(chatPartners).sort((a, b) => {
      const timeA = getTimestamp(chatPartners[a].lastMessage?.time);
      const timeB = getTimestamp(chatPartners[b].lastMessage?.time);
      return timeB - timeA; // –û—Ö–∏—Ä–∏–Ω (–±—É–∑—É—Ä–≥—Ç–∞—Ä–∏–Ω timestamp) –¥–∞—Ä –±–æ–ª–æ
  });

  // 3. –ù–∞–º–æ–∏—à
  sortedPartners.forEach(partnerEmail => {
    const userEncoded = encodeURIComponent(partnerEmail).replace(/\./g, '%2E');
    const user = allUsers[userEncoded];
    const partnerData = chatPartners[partnerEmail];

    if (!user) return; 
    
    const lastMessage = partnerData.lastMessage;
    const lastMessagePrefix = lastMessage ? (lastMessage.sender === currentUser.email ? '–®—É–º–æ: ' : '') : '';
    const lastMessageText = lastMessage ? lastMessagePrefix + lastMessage.text.slice(0, 30) + (lastMessage.text.length > 30 ? '...' : '') : '–ü–∞—ë–º“≥–æ –º–∞–≤“∑—É–¥ –Ω–µ—Å—Ç';
    
    // **–õ–æ–≥–∏–∫–∞–∏ Last Seen/–°—Ç–∞—Ç—É—Å**
    const isOnline = user.lastSeen && (Date.now() - user.lastSeen < 5 * 60 * 1000); 
    const statusText = isOnline ? 
        '<span style="color: var(--online); font-weight: 500;">–û–Ω–ª–∞–π–Ω</span>' : 
        formatLastSeen(user.lastSeen); 

    const li = document.createElement('li');
    li.style.margin = '0';
    li.innerHTML = `
        <div class="chat-list-item" onclick="openChat('${partnerEmail}', true)">
            <div class="chat-info">
                <div class="online-status ${isOnline ? 'online' : ''}"></div>
                <div>
                    <div>
                        <strong>${escapeHtml(user.name)}</strong> 
                        <span class="muted" style="font-size: 11px;">(${user.role === 'korfarmo' ? '–ö–æ—Ä—Ñ–∞—Ä–º–æ' : '–ö–æ—Ä—ë–±'})</span>
                    </div>
                    <div class="last-message">${escapeHtml(lastMessageText)}</div>
                </div>
            </div>
            <div class="muted" style="font-size: 11px; text-align: right;">
                ${statusText}
            </div>
        </div>
    `;
    chatUsers.appendChild(li);
  });
}

// openChat –±–æ –ø–∞—Ä–∞–º–µ—Ç—Ä–∏ –∏–ª–æ–≤–∞–≥”£ (isNewChat)
function openChat(otherEmail, isNewChat = true){
  if(!currentUser) return;
  
  if(currentChatPartnerEmail && isNewChat) {
    const oldChatKey = getChatKey(currentUser.email, currentChatPartnerEmail);
    db.ref(DB_CHATS + '/' + oldChatKey).off('value');
  }

  currentChatPartnerEmail = otherEmail;
  document.getElementById('chatInput').dataset.otherEmail = otherEmail;
  
  const partnerEncoded = encodeURIComponent(otherEmail).replace(/\./g, '%2E');
  const partner = allUsers[partnerEncoded];
  
  // 1. –ù–ê–í–°–û–ó–ò–ò –ú–ê–™–õ–£–ú–û–¢ –î–ê–† –°–ê–†–õ–ê–í“≤–ê–ò –ß–ê–¢
  document.getElementById('chatModalTitle').innerText = partner ? `${partner.name}` : '–ß–∞—Ç';
  
  const chatLastSeenElement = document.getElementById('chatLastSeen');
  if (partner) {
      const lastSeenText = formatLastSeen(partner.lastSeen);
      chatLastSeenElement.innerHTML = lastSeenText === '–û–Ω–ª–∞–π–Ω' ? 
          `<span style="color: var(--online); font-weight: bold;">${lastSeenText}</span>` : 
          `–û—Ö–∏—Ä–∏–Ω –¥–∏–¥–∞–Ω: ${lastSeenText}`;
  } else {
      chatLastSeenElement.innerText = '';
  }
  // ----------------------------------------------------
  
  document.getElementById('chatList').style.display = 'none';
  document.getElementById('chatWindow').style.display = 'flex'; 
  
  const chatKey = getChatKey(currentUser.email, otherEmail);
  const chatRef = db.ref(DB_CHATS + '/' + chatKey);
  
  if (isNewChat) { // –§–∞“õ–∞—Ç –∞–≥–∞—Ä –±–æ—Ä–∏ –∞–≤–≤–∞–ª –∫—É—à–æ–¥–∞ —à–∞–≤–∞–¥, listener-—Ä–æ –∏–ª–æ–≤–∞ –º–µ–∫—É–Ω–µ–º
    chatRef.on('value', (snapshot) => {
      const messages = snapshot.val();
      const chatMessages = document.getElementById('chatMessages');
      chatMessages.innerHTML = '';
      
      if(messages){
        Object.keys(messages).forEach(key => {
          const msg = messages[key];
          const div = document.createElement('div');
          div.className = `chat-message ${msg.sender === currentUser.email ? 'sent' : 'received'}`;
          
          let readStatus = '';
          if (msg.sender === currentUser.email) {
              // –ò—Å—Ç–∏—Ñ–æ–¥–∞–∏ ‚úì‚úì –±–∞—Ä–æ–∏ –î–∏–¥–∞ —à—É–¥
              readStatus = msg.read ? 
                  ' <span style="font-size:10px; color:var(--read-receipt); margin-left:5px;">‚úì‚úì</span>' : 
                  ' <span style="font-size:10px; color:#888; margin-left:5px;">‚úì</span>'; 
          }
          
          const messageText = document.createElement('span');
          messageText.innerText = escapeHtml(msg.text);

          const metadata = document.createElement('span');
          metadata.className = 'muted';
          metadata.style.fontSize = '10px';
          metadata.innerHTML = `${new Date(msg.time).toLocaleTimeString('tg-TJ').slice(0, 5)} ${readStatus}`;
          
          div.appendChild(messageText);
          div.appendChild(metadata);

          chatMessages.appendChild(div);
        });
      }
      chatMessages.scrollTop = chatMessages.scrollHeight; 
      
      // –ê–ú–ê–õ–ò –ê–°–û–°”¢: “≤–∞–º–∞–∏ –ø–∞—ë–º“≥–æ–∏ “õ–∞–±—É–ª–∫–∞—Ä–¥–∞—à—É–¥–∞—Ä–æ “≥–∞–º—á—É–Ω "–¥–∏–¥–∞ —à—É–¥" –º–∞—Ä–∫ –º–µ–∫—É–Ω–µ–º
      markMessagesAsRead(chatKey); 
    });
  }

  document.getElementById('chatInput').focus();
}

async function sendMessage(){
  if(!currentUser || !currentChatPartnerEmail) return;
  
  const text = document.getElementById('chatInput').value.trim();
  if(text){
    const chatKey = getChatKey(currentUser.email, currentChatPartnerEmail);
    // –ò–ª–æ–≤–∞–∏ read: false
    const message = { sender: currentUser.email, text, time: new Date().toISOString(), read: false }; 
    
    try {
      await db.ref(DB_CHATS + '/' + chatKey).push(message);
      document.getElementById('chatInput').value = '';
      
      const partnerEncodedEmail = encodeURIComponent(currentChatPartnerEmail).replace(/\./g, '%2E');
      await db.ref('userNotifications/' + partnerEncodedEmail).set(true); 
      
    } catch (error) {
      alert('–•–∞—Ç–æ–∏ —Ñ–∏—Ä–∏—Å—Ç–æ–¥–∞–Ω–∏ –ø–∞—ë–º: ' + error.message);
    }
  }
}

function startChatWith(otherEmail){
  if(!currentUser) { alert('–õ—É—Ç—Ñ–∞–Ω, –∞–≤–≤–∞–ª –≤–æ—Ä–∏–¥ —à–∞–≤–µ–¥ —ë —Å–∞–±—Ç–∏ –Ω–æ–º –∫—É–Ω–µ–¥.'); return; }
  currentChatPartnerEmail = otherEmail;
  document.getElementById('chatInput').dataset.otherEmail = otherEmail;
  openModal('chatModal');
  openChat(otherEmail, true);
}

function addNewProject(){
  alert('–ò–ª–æ–≤–∞–∏ –ª–æ–∏“≥–∞–∏ –Ω–∞–≤ (–¥–∞—Ä –Ω—É—Å—Ö–∞–∏ –¥–µ–º–æ “ì–∞–π—Ä–∏—Ñ–∞—ä–æ–ª).');
}

/* --------- helpers ---------- */
function escapeHtml(s){ 
    return (s || '').replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); 
}

/* --------- bindings & startup ---------- */
const searchInput = document.getElementById('searchInput');
const cityFilter = document.getElementById('cityFilter');
searchInput.addEventListener('input', () => renderJobs(searchInput.value, cityFilter.value));
cityFilter.addEventListener('change', () => renderJobs(searchInput.value, cityFilter.value));

document.querySelectorAll('.modal').forEach(m => m.addEventListener('click', e => { if(e.target === m) closeModal(m.id); }));

</script>
</body>
</html>
